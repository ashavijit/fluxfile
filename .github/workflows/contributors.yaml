name: Contributors

on:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-contributors:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate contributors file
        run: |
          cat > CONTRIBUTORS.md << 'HEADER'
          <div align="center">

          # ðŸ‘¥ Contributors

          <p>Thanks to all the amazing people who have contributed to FluxFile! ðŸŽ‰</p>

          </div>

          ---

          ## ðŸ† Top Contributors

          HEADER

          # Generate contributor table
          echo "| # | Avatar | Contributor | Commits | Lines Added | Lines Deleted |" >> CONTRIBUTORS.md
          echo "|:-:|:------:|-------------|:-------:|:-----------:|:-------------:|" >> CONTRIBUTORS.md

          rank=1
          git shortlog -sne --all | head -10 | while IFS= read -r line; do
            count=$(echo "$line" | awk '{print $1}')
            # Extract email from <email> format
            email=$(echo "$line" | grep -oP '(?<=<)[^>]+(?=>)')
            name=$(echo "$line" | sed 's/^[[:space:]]*[0-9]*[[:space:]]*//' | sed 's/<.*//' | xargs)

            # Try to get GitHub username
            if [[ "$email" == *"@users.noreply.github.com"* ]]; then
              github_user=$(echo "$email" | sed 's/@users.noreply.github.com//' | sed 's/^[0-9]*+//')
            elif [[ "$email" == *"github-actions"* ]]; then
              github_user="github-actions[bot]"
            else
              # Use name as fallback, replace spaces
              github_user=$(echo "$name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
            fi

            # Get lines added/deleted for this author
            stats=$(git log --author="$name" --pretty=tformat: --numstat 2>/dev/null | awk '{ add += $1; del += $2 } END { printf "%d|%d", add, del }')
            added=$(echo "$stats" | cut -d'|' -f1)
            deleted=$(echo "$stats" | cut -d'|' -f2)

            # Add medal for top 3
            medal=""
            case $rank in
              1) medal="ðŸ¥‡ " ;;
              2) medal="ðŸ¥ˆ " ;;
              3) medal="ðŸ¥‰ " ;;
            esac

            echo "| ${medal}${rank} | <img src=\"https://github.com/${github_user}.png\" width=\"40\" style=\"border-radius:50%\"> | **[@${github_user}](https://github.com/${github_user})** | ${count} | +${added:-0} | -${deleted:-0} |" >> CONTRIBUTORS.md

            rank=$((rank + 1))
          done

          # Add contribution pie chart
          cat >> CONTRIBUTORS.md << 'PIE'

          ---

          ## ðŸ“Š Contribution Statistics

          ### Commits by Author

          ```mermaid
          %%{init: {'theme': 'dark', 'themeVariables': { 'pie1': '#6366f1', 'pie2': '#8b5cf6', 'pie3': '#a855f7', 'pie4': '#d946ef', 'pie5': '#ec4899', 'pie6': '#f43f5e', 'pie7': '#f97316', 'pie8': '#eab308'}}}%%
          pie showData
              title Commits Distribution
          PIE

          git shortlog -sn --all | head -8 | while read count name; do
            clean_name=$(echo "$name" | tr -d '"' | head -c 20)
            echo "    \"$clean_name\" : $count" >> CONTRIBUTORS.md
          done
          echo '```' >> CONTRIBUTORS.md

          # Add recent commits timeline
          cat >> CONTRIBUTORS.md << 'RECENT'

          ---

          ## ðŸ• Recent Activity

          ### Last 15 Commits

          | Date | Author | Commit | Message |
          |:----:|--------|:------:|---------|
          RECENT

          git log --pretty=format:'| `%ad` | %an | [`%h`](../../commit/%H) | %s |' --date=short -15 >> CONTRIBUTORS.md

          # Add commit timeline chart
          cat >> CONTRIBUTORS.md << 'TIMELINE'

          ---

          ### Commit Timeline

          ```mermaid
          %%{init: {'theme': 'dark', 'themeVariables': { 'primaryColor': '#6366f1'}}}%%
          timeline
              title Recent Development Activity
          TIMELINE

          # Group commits by date
          git log --format='%ad' --date=short -30 | sort | uniq -c | tail -10 | while read count date; do
            echo "    $date : $count commits" >> CONTRIBUTORS.md
          done
          echo '```' >> CONTRIBUTORS.md

          # Add footer
          cat >> CONTRIBUTORS.md << 'END'

          ---

          <div align="center">

          ### ðŸ’œ Want to Contribute?

          Check out our [Contributing Guide](CONTRIBUTING.md) to get started!

          [![Open Issues](https://img.shields.io/github/issues/ashavijit/fluxfile?style=for-the-badge&color=6366f1)](https://github.com/ashavijit/fluxfile/issues)
          [![PRs Welcome](https://img.shields.io/badge/PRs-welcome-brightgreen.svg?style=for-the-badge)](https://github.com/ashavijit/fluxfile/pulls)

          </div>

          ---

          END

          echo "*Auto-generated on $(date -u '+%Y-%m-%d %H:%M UTC')*" >> CONTRIBUTORS.md

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CONTRIBUTORS.md
          git diff --staged --quiet || git commit -m "docs: update contributors"
          git push
