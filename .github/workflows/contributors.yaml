name: Contributors

on:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday at midnight
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  contributors:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate contributor list
        id: contributors
        run: |
          echo "## ðŸ‘¥ Contributors" > CONTRIBUTORS.md
          echo "" >> CONTRIBUTORS.md
          echo "Thanks to all the amazing contributors! ðŸŽ‰" >> CONTRIBUTORS.md
          echo "" >> CONTRIBUTORS.md

          # Get contributors with commit count
          echo "| Avatar | Contributor | Commits |" >> CONTRIBUTORS.md
          echo "|--------|-------------|---------|" >> CONTRIBUTORS.md

          git shortlog -sne --all | while read commits email name; do
            username=$(echo "$name" | sed 's/<.*>//' | xargs)
            github_user=$(git log --author="$name" --format='%ae' | head -1 | cut -d@ -f1)
            echo "| <img src=\"https://github.com/${github_user}.png\" width=\"50\"> | [@${github_user}](https://github.com/${github_user}) | ${commits} |" >> CONTRIBUTORS.md
          done

          echo "" >> CONTRIBUTORS.md
          echo "---" >> CONTRIBUTORS.md
          echo "*Auto-generated on $(date -u '+%Y-%m-%d')*" >> CONTRIBUTORS.md

      - name: Generate contribution stats
        run: |
          echo "" >> CONTRIBUTORS.md
          echo "## ðŸ“Š Contribution Statistics" >> CONTRIBUTORS.md
          echo "" >> CONTRIBUTORS.md
          echo "### Commits per Author" >> CONTRIBUTORS.md
          echo '```' >> CONTRIBUTORS.md
          git shortlog -sn --all | head -20 >> CONTRIBUTORS.md
          echo '```' >> CONTRIBUTORS.md

          echo "" >> CONTRIBUTORS.md
          echo "### Recent Activity (Last 30 days)" >> CONTRIBUTORS.md
          echo '```' >> CONTRIBUTORS.md
          git log --since="30 days ago" --pretty=format:"%h %s (%an)" --abbrev-commit | head -20 >> CONTRIBUTORS.md
          echo '```' >> CONTRIBUTORS.md

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CONTRIBUTORS.md
          git diff --staged --quiet || git commit -m "docs: update contributors list"
          git push

  contribution-graph:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate contribution graph (Mermaid)
        run: |
          mkdir -p docs

          cat > docs/CONTRIBUTION_GRAPH.md << 'EOF'
          # Contribution Activity

          ## Weekly Commit Activity

          ```mermaid
          %%{init: {'theme': 'dark'}}%%
          gitGraph
             commit id: "Initial"
          EOF

          # Add recent commits to graph
          git log --oneline -20 --reverse | while read hash msg; do
            short_msg=$(echo "$msg" | head -c 30)
            echo "   commit id: \"$short_msg\"" >> docs/CONTRIBUTION_GRAPH.md
          done

          echo '```' >> docs/CONTRIBUTION_GRAPH.md

          # Add contributor pie chart
          cat >> docs/CONTRIBUTION_GRAPH.md << 'EOF'

          ## Contributions by Author

          ```mermaid
          pie showData
              title Commits by Contributor
          EOF

          git shortlog -sn --all | head -10 | while read count name; do
            echo "    \"$name\" : $count" >> docs/CONTRIBUTION_GRAPH.md
          done

          echo '```' >> docs/CONTRIBUTION_GRAPH.md
          echo "" >> docs/CONTRIBUTION_GRAPH.md
          echo "*Last updated: $(date -u '+%Y-%m-%d %H:%M UTC')*" >> docs/CONTRIBUTION_GRAPH.md

      - name: Commit graph
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/CONTRIBUTION_GRAPH.md
          git diff --staged --quiet || git commit -m "docs: update contribution graph"
          git push
